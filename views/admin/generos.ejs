<%- include('../partials/header', { title: 'Administrar Géneros' }) %>

<div class="container mt-4">
  <h2 class="text-white">Géneros</h2>

  <!-- Insert -->
  <form id="form-insert-genero" enctype="multipart/form-data">
    <h4 class="text-white">Crear Género</h4>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Imagen</label>
      <input type="file" name="imagen" class="form-control" />
    </div>
    <button class="btn btn-success">Crear</button>
  </form>

  <!-- PUT -->
  <form id="form-put-genero" enctype="multipart/form-data" class="mt-3">
    <h4 class="text-white">Actualizar Género (PUT)</h4>
    <div class="mb-3">
      <label class="form-label text-white">ID</label>
      <input type="number" name="id" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Imagen</label>
      <input type="file" name="imagen" class="form-control" />
    </div>
    <button class="btn btn-primary">Actualizar (PUT)</button>
  </form>

  <!-- PATCH -->
  <form id="form-patch-genero" enctype="multipart/form-data" class="mt-3">
    <h4 class="text-white">Actualizar Género (PATCH)</h4>
    <div class="mb-3">
      <label class="form-label text-white">ID</label>
      <input type="number" name="id" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Imagen</label>
      <input type="file" name="imagen" class="form-control" />
    </div>
    <button class="btn btn-warning">Actualizar (PATCH)</button>
  </form>

  <!-- DELETE -->
  <form id="form-delete-genero" class="mt-3">
    <h4 class="text-white">Eliminar Género</h4>
    <div class="mb-3">
      <label class="form-label text-white">ID</label>
      <input type="number" name="id" class="form-control" required />
    </div>
    <button class="btn btn-danger">Eliminar</button>
  </form>

  <!-- SEARCH -->
  <form id="form-search-genero" class="mt-3">
    <h4 class="text-white">Buscar Género</h4>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" />
    </div>
    <button class="btn btn-info">Buscar</button>
  </form>

  <div id="resultado" class="mt-3 text-white"></div>
</div>

<script>
  const resultado = document.getElementById("resultado");

  async function parseResponse(res) {
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) {
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || JSON.stringify(json));
      return json;
    } else {
      const text = await res.text();
      if (!res.ok) throw new Error(text || `Error ${res.status}`);
      return text;
    }
  }

  // INSERT
  document
    .getElementById("form-insert-genero")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      try {
        const res = await fetch("/generos", { method: "POST", body: fd });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // PUT
  document
    .getElementById("form-put-genero")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const id = form.querySelector('[name="id"]').value.trim();
      if (!id) return (resultado.textContent = "Error: falta el ID");

      const fd = new FormData(form);
      fd.delete("id");

      try {
        const res = await fetch(`/generos/${id}`, { method: "PUT", body: fd });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // PATCH
  document
    .getElementById("form-patch-genero")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const id = form.querySelector('[name="id"]').value.trim();
      if (!id) return (resultado.textContent = "Error: falta el ID");

      const fd = new FormData(form);
      fd.delete("id");

      try {
        const res = await fetch(`/generos/${id}`, {
          method: "PATCH",
          body: fd,
        });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // DELETE
  document
    .getElementById("form-delete-genero")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = e.target.querySelector('[name="id"]').value.trim();
      if (!id) return (resultado.textContent = "Error: falta el ID");

      try {
        const res = await fetch(`/generos/${id}`, { method: "DELETE" });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // SEARCH
  document
    .getElementById("form-search-genero")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const body = new FormData(e.target);
      const obj = Object.fromEntries(body.entries());
      try {
        const res = await fetch("/generos/search", {
          method: "POST",
          body: JSON.stringify(obj),
          headers: { "Content-Type": "application/json" },
        });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });
</script>

<%- include('../partials/footer') %>
