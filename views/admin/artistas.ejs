<%- include('../partials/header', { title: 'Administrar Artistas' }) %>

<div class="container mt-4">
  <h2 class="text-white">Artistas</h2>

  <!-- Insert -->
  <form id="form-insert-artista" enctype="multipart/form-data">
    <h4 class="text-white">Crear Artista</h4>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Imagen</label>
      <input type="file" name="imagen" class="form-control" />
    </div>
    <button class="btn btn-success">Crear</button>
  </form>

  <!-- PUT -->
  <form id="form-put-artista" enctype="multipart/form-data" class="mt-3">
    <h4 class="text-white">Actualizar Artista (PUT)</h4>
    <div class="mb-3">
      <label class="form-label text-white">ID</label>
      <input type="text" name="id" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Imagen</label>
      <input type="file" name="imagen" class="form-control" required />
    </div>
    <button class="btn btn-primary">Actualizar (PUT)</button>
  </form>

  <!-- PATCH -->
  <form id="form-patch-artista" enctype="multipart/form-data" class="mt-3">
    <h4 class="text-white">Actualizar Artista (PATCH)</h4>
    <div class="mb-3">
      <label class="form-label text-white">ID</label>
      <input type="text" name="id" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" />
    </div>
    <div class="mb-3">
      <label class="form-label text-white">Imagen</label>
      <input type="file" name="imagen" class="form-control" />
    </div>
    <button class="btn btn-warning">Actualizar (PATCH)</button>
  </form>

  <!-- Delete -->
  <form id="form-delete-artista" class="mt-3">
    <h4 class="text-white">Eliminar Artista</h4>
    <div class="mb-3">
      <label class="form-label text-white">ID</label>
      <input type="text" name="id" class="form-control" required />
    </div>
    <button class="btn btn-danger">Eliminar</button>
  </form>

  <!-- Search -->
  <form id="form-search-artista" class="mt-3">
    <h4 class="text-white">Buscar Artista</h4>
    <div class="mb-3">
      <label class="form-label text-white">Nombre</label>
      <input type="text" name="nombre" class="form-control" />
    </div>
    <button class="btn btn-info">Buscar</button>
  </form>

  <div id="resultado" class="mt-3 text-white"></div>
</div>

<script>
  const resultado = document.getElementById("resultado");

  async function parseResponse(res) {
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) {
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || JSON.stringify(json));
      return json;
    } else {
      const text = await res.text();
      if (!res.ok) throw new Error(text || `Error ${res.status}`);
      return text;
    }
  }

  // INSERT
  document
    .getElementById("form-insert-artista")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      resultado.textContent = "Enviando...";
      const fd = new FormData(e.target);
      try {
        const res = await fetch("/artistas", { method: "POST", body: fd });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // PUT
  document
    .getElementById("form-put-artista")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const id = form.querySelector('[name="id"]').value.trim();
      if (!id) return (resultado.textContent = "Error: falta el ID");

      resultado.textContent = "Enviando (PUT)...";
      const fd = new FormData(form);
      fd.delete("id");

      try {
        const res = await fetch(`/artistas/${id}`, { method: "PUT", body: fd });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // PATCH
  document
    .getElementById("form-patch-artista")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const id = form.querySelector('[name="id"]').value.trim();
      if (!id) return (resultado.textContent = "Error: falta el ID");

      resultado.textContent = "Enviando (PATCH)...";
      const fd = new FormData(form);
      fd.delete("id");

      try {
        const res = await fetch(`/artistas/${id}`, {
          method: "PATCH",
          body: fd,
        });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // DELETE
  document
    .getElementById("form-delete-artista")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = e.target.querySelector('[name="id"]').value.trim();
      if (!id) return (resultado.textContent = "Error: falta el ID");

      resultado.textContent = "Eliminando...";
      try {
        const res = await fetch(`/artistas/${id}`, { method: "DELETE" });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });

  // SEARCH
  document
    .getElementById("form-search-artista")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      resultado.textContent = "Buscando...";
      const body = Object.fromEntries(new FormData(e.target).entries());
      try {
        const res = await fetch(`/artistas/search`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await parseResponse(res);
        resultado.innerHTML =
          "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      } catch (err) {
        resultado.textContent = "Error: " + err.message;
      }
    });
</script>

<%- include('../partials/footer') %>
